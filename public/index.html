<!DOCTYPE html>
<html lang="id" class="dark">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>TTS App</title>
    <link rel="manifest" href="/manifest" />
    <link rel="shortcut icon"
        href="https://5p6ektjr8d.ucarecd.net/b6482a06-4416-48fc-affe-2ea3423154e3/Gemini_Generated_Image_drpsxdrpsxdrpsxd.png"
        type="image/x-icon">
            <link rel="apple-touch-icon" href="https://5p6ektjr8d.ucarecd.net/b6482a06-4416-48fc-affe-2ea3423154e3/Gemini_Generated_Image_drpsxdrpsxdrpsxd.png" />
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        zinc: { 850: '#202022', 900: '#18181b', 950: '#09090b' }
                    },
                    fontFamily: { sans: ['Inter', 'sans-serif'] }
                }
            }
        }
    </script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');

        /* Mobile Optimization: Hide scrollbars but keep functionality */
        textarea::-webkit-scrollbar {
            width: 4px;
        }

        textarea::-webkit-scrollbar-thumb {
            background-color: #52525b;
            border-radius: 20px;
        }

        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none;
            height: 20px;
            width: 20px;
            /* Lebih besar untuk jempol HP */
            border-radius: 50%;
            background: #6366f1;
            cursor: pointer;
            margin-top: -8px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }

        input[type=range]::-webkit-slider-runnable-track {
            width: 100%;
            height: 4px;
            background: #3f3f46;
            border-radius: 2px;
        }

        .highlight-active {
            border-color: #6366f1;
            box-shadow: 0 0 0 2px rgba(99, 102, 241, 0.2);
        }

        /* Prevent zoom on inputs for iOS */
        select,
        textarea,
        input {
            font-size: 16px !important;
        }
    </style>
</head>

<body
    class="bg-zinc-100 text-zinc-800 dark:bg-zinc-950 dark:text-zinc-300 font-sans min-h-screen flex flex-col transition-colors duration-300 selection:bg-indigo-500 selection:text-white overscroll-none">

    <nav
        class="w-full border-b border-zinc-200 dark:border-zinc-800 bg-white/90 dark:bg-zinc-950/90 backdrop-blur-md sticky top-0 z-40">
        <div class="max-w-3xl mx-auto px-4 py-3 flex justify-between items-center">
            <div class="flex items-center gap-2">
                <div class="w-2.5 h-2.5 bg-indigo-500 rounded-full animate-pulse"></div>
                <h1 class="font-bold tracking-tight text-lg">Material<span class="text-indigo-500">Reader</span></h1>
            </div>
            <button id="themeToggle"
                class="p-2 rounded-full bg-zinc-100 dark:bg-zinc-900 hover:bg-zinc-200 dark:hover:bg-zinc-800 transition-all focus:outline-none ring-1 ring-zinc-200 dark:ring-zinc-800">
                <svg id="sunIcon" class="w-5 h-5 hidden text-amber-500" fill="none" stroke="currentColor"
                    viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z">
                    </path>
                </svg>
                <svg id="moonIcon" class="w-5 h-5 hidden text-indigo-400" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-moon-icon lucide-moon"><path d="M20.985 12.486a9 9 0 1 1-9.473-9.472c.405-.022.617.46.402.803a6 6 0 0 0 8.268 8.268c.344-.215.825-.004.803.401"/></svg>
            </button>
        </div>
    </nav>

    <main class="flex-1 w-full max-w-3xl mx-auto px-4 py-6 flex flex-col gap-5 pb-36">

        <div class="space-y-2">
            <div class="flex justify-between items-end px-1">
                <label class="text-xs font-semibold uppercase tracking-wider text-zinc-500">Materi Teks</label>
                <button id="clearBtn"
                    class="text-xs text-red-500 hover:text-red-600 font-medium px-2 py-1 rounded hover:bg-red-50 dark:hover:bg-red-900/10 transition">Reset</button>
            </div>
            <div class="relative group">
                <textarea id="textInput" rows="8"
                    class="relative w-full bg-white dark:bg-zinc-900 border border-zinc-200 dark:border-zinc-800 rounded-xl p-4 text-base leading-relaxed focus:outline-none focus:ring-1 focus:ring-indigo-500/50 placeholder-zinc-400 dark:placeholder-zinc-600 resize-none transition-all shadow-sm font-medium text-zinc-600 dark:text-zinc-400"
                    placeholder="Tempel materi di sini..."></textarea>
            </div>
            <div class="flex justify-between text-xs text-zinc-400 px-1">
                <span id="charCount">0 Karakter</span>
                <span id="statusMsg" class="font-bold text-indigo-500">Menunggu suara...</span>
            </div>
        </div>

        <div
            class="bg-white dark:bg-zinc-900 p-5 rounded-2xl border border-zinc-200 dark:border-zinc-800 shadow-sm flex flex-col gap-5">

            <div class="space-y-3">
                <label class="text-xs font-bold uppercase text-zinc-500">Bahasa</label>
                <div class="flex gap-2">
                    <button
                        class="lang-btn flex-1 py-2.5 px-3 text-sm font-medium rounded-lg border border-zinc-200 dark:border-zinc-700 active-lang"
                        data-lang="id">ðŸ‡®ðŸ‡© Indo</button>
                    <button
                        class="lang-btn flex-1 py-2.5 px-3 text-sm font-medium rounded-lg border border-zinc-200 dark:border-zinc-700"
                        data-lang="en">ðŸ‡ºðŸ‡¸ Eng</button>
                    <button
                        class="lang-btn flex-1 py-2.5 px-3 text-sm font-medium rounded-lg border border-zinc-200 dark:border-zinc-700"
                        data-lang="ja">ðŸ‡¯ðŸ‡µ JP</button>
                </div>
            </div>

            <div class="space-y-3">
                <label class="text-xs font-bold uppercase text-zinc-500">Model Suara</label>
                <div class="relative">
                    <select id="voiceSelect"
                        class="w-full appearance-none bg-zinc-50 dark:bg-zinc-850 border border-zinc-200 dark:border-zinc-700 rounded-lg px-4 py-3 text-sm focus:border-indigo-500 focus:outline-none transition-colors truncate pr-8">
                        <option value="">Sedang mencari suara...</option>
                    </select>
                    <div class="pointer-events-none absolute inset-y-0 right-0 flex items-center px-3 text-zinc-500">
                        <svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7">
                            </path>
                        </svg>
                    </div>
                </div>
            </div>

            <div class="space-y-4">
                <div class="flex justify-between">
                    <label class="text-xs font-bold uppercase text-zinc-500">Kecepatan</label>
                    <span id="speedValue"
                        class="text-xs font-mono font-bold text-indigo-500 bg-indigo-50 dark:bg-indigo-900/20 px-2 py-0.5 rounded">1.0x</span>
                </div>
                <input type="range" id="speedInput" min="0.5" max="2.0" step="0.1" value="1.0"
                    class="w-full h-2 bg-zinc-200 dark:bg-zinc-700 rounded-lg appearance-none cursor-pointer">
            </div>
        </div>
    </main>

    <div class="fixed bottom-6 left-1/2 transform -translate-x-1/2 w-[92%] max-w-lg z-50">
        <div
            class="bg-white/90 dark:bg-zinc-900/90 backdrop-blur-xl p-3 rounded-2xl border border-white/20 dark:border-zinc-700 shadow-2xl flex items-center gap-3 ring-1 ring-black/5">

            <button id="loopBtn"
                class="p-4 rounded-xl border border-zinc-200 dark:border-zinc-700 text-zinc-400 hover:text-indigo-500 transition-all active:scale-90"
                title="Looping">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15">
                    </path>
                </svg>
            </button>

            <button id="playBtn"
                class="flex-1 py-4 bg-indigo-600 hover:bg-indigo-700 text-white rounded-xl font-bold flex justify-center items-center gap-2 transition-transform active:scale-95 shadow-lg shadow-indigo-500/30">
                <svg id="playIcon" class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M14.752 11.168l-3.197-2.132A1 1 0 0010 9.87v4.263a1 1 0 001.555.832l3.197-2.132a1 1 0 000-1.664z">
                    </path>
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                </svg>
                <span id="playText">Mulai</span>
            </button>

        </div>
    </div>

    <script>
        if ("serviceWorker" in navigator) {
            window.addEventListener("load", () => {
                navigator.serviceWorker.register("/sw").catch(console.error);
            });
        }
        // --- CORE VARIABLES ---
        const synth = window.speechSynthesis;
        let voices = [];
        let currentLang = 'id';
        let isLooping = false;
        let isPlaying = false;
        let voiceLoadAttempts = 0; // Untuk retry loading suara

        // --- QUEUE SYSTEM ---
        let sentenceQueue = [];
        let currentSentenceIndex = 0;

        // --- DOM ELEMENTS ---
        const textInput = document.getElementById('textInput');
        const voiceSelect = document.getElementById('voiceSelect');
        const speedInput = document.getElementById('speedInput');
        const speedValue = document.getElementById('speedValue');
        const statusMsg = document.getElementById('statusMsg');
        const playBtn = document.getElementById('playBtn');
        const loopBtn = document.getElementById('loopBtn');
        const clearBtn = document.getElementById('clearBtn');
        const charCount = document.getElementById('charCount');
        const langBtns = document.querySelectorAll('.lang-btn');

        // --- 1. VOICE LOADING (MOBILE FIX: POLLING) ---
        // Browser HP lambat memuat suara, jadi kita cek terus sampai ada
        function populateVoiceList() {
            voices = synth.getVoices();

            // Jika suara masih kosong dan belum mencoba 10 kali (5 detik), coba lagi nanti
            if (voices.length === 0 && voiceLoadAttempts < 20) {
                voiceLoadAttempts++;
                statusMsg.textContent = `Memuat suara... (${voiceLoadAttempts})`;
                setTimeout(populateVoiceList, 250); // Cek lagi setiap 250ms
                return;
            }

            const langCodeMap = { 'id': 'id', 'en': 'en', 'ja': 'ja' };
            const targetCode = langCodeMap[currentLang];

            // Filter suara sesuai bahasa
            const filteredVoices = voices.filter(voice => voice.lang.includes(targetCode));

            voiceSelect.innerHTML = '';

            if (filteredVoices.length === 0) {
                const opt = document.createElement('option');
                opt.text = "Gunakan Suara Default Sistem";
                opt.value = "default";
                voiceSelect.appendChild(opt);
                statusMsg.textContent = "Suara default aktif";
            } else {
                filteredVoices.forEach(voice => {
                    const opt = document.createElement('option');
                    // Bersihkan nama agar tidak terlalu panjang di HP
                    let cleanName = voice.name.replace('Google', '').replace('Microsoft', '').replace('English', '').replace('Indonesian', '').trim();
                    opt.textContent = cleanName || voice.name;
                    opt.value = voice.name;

                    // Prioritas Google / Indo
                    if (currentLang === 'id' && (voice.name.includes('Indonesia') || voice.name.includes('ID'))) {
                        opt.selected = true;
                    }
                    voiceSelect.appendChild(opt);
                });
                statusMsg.textContent = "Siap.";
            }
        }

        // Panggil saat load, dan pasang event listener
        populateVoiceList();
        if (synth.onvoiceschanged !== undefined) {
            synth.onvoiceschanged = populateVoiceList;
        }

        // --- 2. TEXT CHUNKING (MOBILE FIX: SMALL CHUNKS) ---
        // Potong kalimat jadi sangat kecil (<100 char) agar HP tidak timeout
        function prepareText(text) {
            let cleanText = text.replace(/\s+/g, ' ').trim();
            // Split based on punctuations
            let rawChunks = cleanText.match(/[^.?!:;\n]+[.?!:;\n]+|[^.?!:;\n]+$/g) || [cleanText];

            let finalChunks = [];
            const MOBILE_MAX_LENGTH = 100; // Dikurangi dari 160 ke 100 untuk stabilitas HP

            rawChunks.forEach(chunk => {
                if (chunk.length > MOBILE_MAX_LENGTH) {
                    // Split by comma
                    let subChunks = chunk.match(/[^,]+,|[^,]+$/g) || [chunk];
                    subChunks.forEach(sub => {
                        if (sub.length > MOBILE_MAX_LENGTH) {
                            // Split by space if still too long
                            const words = sub.split(' ');
                            let temp = '';
                            words.forEach(word => {
                                if ((temp + word).length < MOBILE_MAX_LENGTH) {
                                    temp += word + ' ';
                                } else {
                                    finalChunks.push(temp.trim());
                                    temp = word + ' ';
                                }
                            });
                            if (temp) finalChunks.push(temp.trim());
                        } else {
                            finalChunks.push(sub.trim());
                        }
                    });
                } else {
                    finalChunks.push(chunk.trim());
                }
            });

            return finalChunks.filter(c => c.length > 0);
        }

        // --- 3. PLAYBACK ENGINE (NO INTERVAL HACK) ---
        function speakChunk() {
            if (!isPlaying) return; // Guard clause

            if (currentSentenceIndex >= sentenceQueue.length) {
                if (isLooping) {
                    currentSentenceIndex = 0;
                    speakChunk();
                } else {
                    stopAll("Selesai");
                }
                return;
            }

            const textChunk = sentenceQueue[currentSentenceIndex];

            // Re-create utterance object every time (Cleanest for Mobile)
            const utterance = new SpeechSynthesisUtterance(textChunk);

            // Set Voice
            if (voiceSelect.value !== 'default') {
                const selectedVoice = voices.find(v => v.name === voiceSelect.value);
                if (selectedVoice) utterance.voice = selectedVoice;
            }

            utterance.rate = parseFloat(speedInput.value);

            // Events
            utterance.onstart = () => {
                statusMsg.textContent = `${currentSentenceIndex + 1}/${sentenceQueue.length}`;
            };

            utterance.onend = () => {
                if (isPlaying) {
                    currentSentenceIndex++;
                    speakChunk(); // Chain execution directly
                }
            };

            utterance.onerror = (e) => {
                console.log("TTS Error:", e);
                // On mobile, 'interrupted' often happens when screen locks. 
                // We try to proceed unless user explicitly cancelled.
                if (e.error !== 'canceled' && isPlaying) {
                    currentSentenceIndex++;
                    speakChunk();
                }
            };

            synth.speak(utterance);
        }

        function startReading() {
            synth.cancel(); // Pastikan bersih

            const text = textInput.value;
            if (!text) return alert("Isi teks dulu!");

            sentenceQueue = prepareText(text);
            if (sentenceQueue.length === 0) return;

            currentSentenceIndex = 0;
            isPlaying = true;

            // UI Update
            textInput.classList.add('highlight-active');
            playBtn.classList.remove('bg-indigo-600');
            playBtn.classList.add('bg-red-500');
            document.getElementById('playText').textContent = "Stop";

            speakChunk();
        }

        function stopAll(msg = "Berhenti") {
            isPlaying = false;
            synth.cancel();
            statusMsg.textContent = msg;
            textInput.classList.remove('highlight-active');

            playBtn.classList.add('bg-indigo-600');
            playBtn.classList.remove('bg-red-500');
            document.getElementById('playText').textContent = "Mulai";
        }

        // --- EVENTS ---
        playBtn.addEventListener('click', () => {
            if (isPlaying) stopAll("Jeda User");
            else startReading();
        });

        loopBtn.addEventListener('click', () => {
            isLooping = !isLooping;
            loopBtn.classList.toggle('text-indigo-500', isLooping);
            loopBtn.classList.toggle('bg-indigo-50', isLooping);
            loopBtn.classList.toggle('dark:bg-indigo-900/30', isLooping);
        });

        clearBtn.addEventListener('click', () => {
            stopAll("Reset");
            textInput.value = '';
            charCount.textContent = '0 Karakter';
        });

        // Language Buttons
        langBtns.forEach(btn => {
            btn.addEventListener('click', () => {
                // Style updates
                langBtns.forEach(b => b.classList.remove('active-lang', 'bg-indigo-100', 'dark:bg-indigo-900/30', 'text-indigo-600', 'dark:text-indigo-400'));
                btn.classList.add('active-lang', 'bg-indigo-100', 'dark:bg-indigo-900/30', 'text-indigo-600', 'dark:text-indigo-400');

                currentLang = btn.dataset.lang;
                // Reset tries to force reload lists if needed
                voiceLoadAttempts = 0;
                populateVoiceList();
            });
        });

        // Utils
        speedInput.addEventListener('input', (e) => speedValue.textContent = e.target.value + 'x');
        textInput.addEventListener('input', () => charCount.textContent = `${textInput.value.length} Karakter`);

        // Theme Init
        const html = document.documentElement;
        if (localStorage.getItem('theme') === 'light') {
            html.classList.remove('dark');
            document.getElementById('sunIcon').classList.remove('hidden');
        } else {
            html.classList.add('dark');
            document.getElementById('moonIcon').classList.remove('hidden');
        }

        document.getElementById('themeToggle').addEventListener('click', () => {
            html.classList.toggle('dark');
            const isDark = html.classList.contains('dark');
            localStorage.setItem('theme', isDark ? 'dark' : 'light');
            document.getElementById('sunIcon').classList.toggle('hidden', isDark);
            document.getElementById('moonIcon').classList.toggle('hidden', !isDark);
        });

        // Initial Style for Active Lang
        document.querySelector('.active-lang').classList.add('bg-indigo-100', 'dark:bg-indigo-900/30', 'text-indigo-600', 'dark:text-indigo-400');

    </script>
</body>

</html>