<!DOCTYPE html>
<html lang="id" class="dark">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="manifest" href="/manifest" />
    <link rel="apple-touch-icon" href="https://5p6ektjr8d.ucarecd.net/b6482a06-4416-48fc-affe-2ea3423154e3/Gemini_Generated_Image_drpsxdrpsxdrpsxd.png" />
    <link rel="shortcut icon"
        href="https://5p6ektjr8d.ucarecd.net/b6482a06-4416-48fc-affe-2ea3423154e3/Gemini_Generated_Image_drpsxdrpsxdrpsxd.png"
        type="image/x-icon">
    <title>TTS App</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        zinc: { 850: '#202022', 900: '#18181b', 950: '#09090b' }
                    },
                    fontFamily: { sans: ['Inter', 'sans-serif'] }
                }
            }
        }
    </script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');

        textarea::-webkit-scrollbar {
            width: 8px;
        }

        textarea::-webkit-scrollbar-track {
            background: transparent;
        }

        textarea::-webkit-scrollbar-thumb {
            background-color: #52525b;
            border-radius: 20px;
        }

        textarea::-webkit-scrollbar-thumb:hover {
            background-color: #71717a;
        }

        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none;
            height: 16px;
            width: 16px;
            border-radius: 50%;
            background: #6366f1;
            cursor: pointer;
            margin-top: -6px;
        }

        input[type=range]::-webkit-slider-runnable-track {
            width: 100%;
            height: 4px;
            cursor: pointer;
            background: #3f3f46;
            border-radius: 2px;
        }

        .highlight-active {
            border-color: #6366f1;
            box-shadow: 0 0 0 2px rgba(99, 102, 241, 0.2);
        }
    </style>
</head>

<body
    class="bg-zinc-100 text-zinc-800 dark:bg-zinc-950 dark:text-zinc-300 font-sans min-h-screen flex flex-col transition-colors duration-300 selection:bg-indigo-500 selection:text-white">

    <nav
        class="w-full border-b border-zinc-200 dark:border-zinc-800 bg-white/80 dark:bg-zinc-950/80 backdrop-blur-md sticky top-0 z-20">
        <div class="max-w-3xl mx-auto px-6 py-4 flex justify-between items-center">
            <div class="flex items-center gap-3">
                <div class="w-3 h-3 bg-indigo-500 rounded-full animate-pulse hidden"></div>
                <h1 class="font-bold tracking-tight text-lg">Text to <span class="text-indigo-500"> Speech</span> <span
                        class="text-[10px]  bg-indigo-500/10 text-indigo-500 px-2 py-0.5 rounded border border-indigo-500/20 ml-1">Yuii</span>
                </h1>
            </div>
            <button id="themeToggle"
                class="p-2.5 rounded-full bg-zinc-100 dark:bg-zinc-900 hover:bg-zinc-200 dark:hover:bg-zinc-800 transition-all focus:outline-none ring-1 ring-zinc-200 dark:ring-zinc-800">
                <svg id="sunIcon" class="w-5 h-5 hidden text-amber-500" fill="none" stroke="currentColor"
                    viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z">
                    </path>
                </svg>
                <svg id="moonIcon" class="w-5 h-5 hidden text-indigo-400" <svg xmlns="http://www.w3.org/2000/svg"
                    width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                    stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-moon-icon lucide-moon">
                    <path
                        d="M20.985 12.486a9 9 0 1 1-9.473-9.472c.405-.022.617.46.402.803a6 6 0 0 0 8.268 8.268c.344-.215.825-.004.803.401" />
                </svg>
            </button>
        </div>
    </nav>

    <main class="flex-1 w-full max-w-3xl mx-auto px-4 py-8 flex flex-col gap-6 pb-32">

        <div class="space-y-2">
            <div class="flex justify-between items-end px-1">
                <label class="text-xs font-semibold uppercase tracking-wider text-zinc-500">Materi Teks</label>
                <button id="clearBtn" class="text-xs text-red-500 hover:text-red-600 hover:underline">Reset</button>
            </div>
            <div class="relative group">
                <div
                    class="absolute -inset-0.5 bg-gradient-to-r from-indigo-500 to-purple-600 rounded-2xl opacity-20 group-focus-within:opacity-100 transition duration-500 blur-sm">
                </div>
                <textarea id="textInput" rows="10"
                    class="relative w-full bg-white dark:bg-zinc-900 border border-zinc-200 dark:border-zinc-800 rounded-xl p-5 text-base md:text-lg leading-relaxed focus:outline-none focus:ring-0 placeholder-zinc-400 dark:placeholder-zinc-600 resize-none transition-all shadow-sm font-medium text-zinc-600 dark:text-zinc-400"
                    placeholder="Your text material.."></textarea>
            </div>
            <div class="flex justify-between text-xs text-zinc-400 px-1">
                <span id="charCount">0 Karakter</span>
                <span id="statusMsg" class="font-bold text-indigo-500">Siap</span>
            </div>
        </div>

        <div
            class="bg-white dark:bg-zinc-900 p-6 rounded-2xl border border-zinc-200 dark:border-zinc-800 shadow-sm grid grid-cols-1 md:grid-cols-2 gap-6">

            <div class="space-y-3">
                <label class="text-xs font-bold uppercase text-zinc-500">Bahasa</label>
                <div class="flex gap-2">
                    <button
                        class="lang-btn flex-1 py-2 px-3 text-sm font-medium rounded-lg border border-zinc-200 dark:border-zinc-700 hover:bg-zinc-50 dark:hover:bg-zinc-800 transition-colors active-lang"
                        data-lang="id">ðŸ‡®ðŸ‡© Indo</button>
                    <button
                        class="lang-btn flex-1 py-2 px-3 text-sm font-medium rounded-lg border border-zinc-200 dark:border-zinc-700 hover:bg-zinc-50 dark:hover:bg-zinc-800 transition-colors"
                        data-lang="en">ðŸ‡ºðŸ‡¸ Eng</button>
                    <button
                        class="lang-btn flex-1 py-2 px-3 text-sm font-medium rounded-lg border border-zinc-200 dark:border-zinc-700 hover:bg-zinc-50 dark:hover:bg-zinc-800 transition-colors"
                        data-lang="ja">ðŸ‡¯ðŸ‡µ JP</button>
                </div>
            </div>

            <div class="space-y-3">
                <label class="text-xs font-bold uppercase text-zinc-500">Model Suara</label>
                <div class="relative">
                    <select id="voiceSelect"
                        class="w-full appearance-none bg-zinc-50 dark:bg-zinc-850 border border-zinc-200 dark:border-zinc-700 rounded-lg px-4 py-2.5 text-sm focus:border-indigo-500 focus:outline-none transition-colors truncate pr-8">
                        <option>Memuat suara...</option>
                    </select>
                    <div class="pointer-events-none absolute inset-y-0 right-0 flex items-center px-2 text-zinc-500">
                        <svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7">
                            </path>
                        </svg>
                    </div>
                </div>
            </div>

            <div class="space-y-3 md:col-span-2">
                <div class="flex justify-between">
                    <label class="text-xs font-bold uppercase text-zinc-500">Kecepatan Bicara</label>
                    <span id="speedValue" class="text-xs font-mono font-bold text-indigo-500">1.0x</span>
                </div>
                <input type="range" id="speedInput" min="0.5" max="2.0" step="0.1" value="1.0"
                    class="w-full bg-zinc-200 dark:bg-zinc-700 rounded-lg h-1.5 appearance-none">
            </div>
        </div>
    </main>

    <div class="fixed bottom-6 left-1/2 transform -translate-x-1/2 w-[90%] max-w-lg z-30">
        <div
            class="bg-white/90 dark:bg-zinc-900/90 backdrop-blur-xl p-3 rounded-2xl border border-white/20 dark:border-zinc-700 shadow-2xl flex items-center gap-3 ring-1 ring-black/5">

            <button id="loopBtn"
                class="p-4 rounded-xl border border-zinc-200 dark:border-zinc-700 text-zinc-400 hover:text-indigo-500 transition-all active:scale-95"
                title="Looping Audio">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15">
                    </path>
                </svg>
            </button>

            <button id="playBtn"
                class="flex-1 py-4 bg-indigo-600 hover:bg-indigo-700 text-white rounded-xl font-bold flex justify-center items-center gap-2 transition-transform active:scale-95 shadow-lg shadow-indigo-500/30">
                <svg id="playIcon" class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M14.752 11.168l-3.197-2.132A1 1 0 0010 9.87v4.263a1 1 0 001.555.832l3.197-2.132a1 1 0 000-1.664z">
                    </path>
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                </svg>
                <span id="playText">Mulai Baca</span>
            </button>

        </div>
    </div>

    <script>
        if ("serviceWorker" in navigator) {
        window.addEventListener("load", () => {
          navigator.serviceWorker.register("/sw").catch(console.error);
        });
      }
        // --- CORE SYSTEM VARIABLES ---
        const synth = window.speechSynthesis;
        let voices = [];
        let currentLang = 'id';
        let isLooping = false;
        let isPlaying = false;

        // --- QUEUE SYSTEM ---
        let sentenceQueue = [];
        let currentSentenceIndex = 0;
        let keepAliveInterval = null;

        // --- GLOBAL UTTERANCE (IMPORTANT FOR GC) ---
        // Wajib ditaruh di window agar tidak dihapus garbage collector browser
        window.utterance = null;

        // --- DOM ELEMENTS ---
        const textInput = document.getElementById('textInput');
        const voiceSelect = document.getElementById('voiceSelect');
        const speedInput = document.getElementById('speedInput');
        const speedValue = document.getElementById('speedValue');
        const statusMsg = document.getElementById('statusMsg');
        const playBtn = document.getElementById('playBtn');
        const loopBtn = document.getElementById('loopBtn');
        const clearBtn = document.getElementById('clearBtn');
        const charCount = document.getElementById('charCount');
        const langBtns = document.querySelectorAll('.lang-btn');

        // --- THEME INIT ---
        function initTheme() {
            const html = document.documentElement;
            const saved = localStorage.getItem('theme');
            if (saved === 'light') {
                html.classList.remove('dark');
                document.getElementById('sunIcon').classList.remove('hidden');
            } else {
                html.classList.add('dark');
                document.getElementById('moonIcon').classList.remove('hidden');
            }
        }
        document.getElementById('themeToggle').addEventListener('click', () => {
            const html = document.documentElement;
            html.classList.toggle('dark');
            const isDark = html.classList.contains('dark');
            localStorage.setItem('theme', isDark ? 'dark' : 'light');
            document.getElementById('sunIcon').classList.toggle('hidden', isDark);
            document.getElementById('moonIcon').classList.toggle('hidden', !isDark);
        });

        // --- TTS ENGINE START ---

        function loadVoices() {
            voices = synth.getVoices();
            if (!voices.length) return;

            const langCodeMap = { 'id': 'id', 'en': 'en', 'ja': 'ja' };
            const targetCode = langCodeMap[currentLang];
            const filteredVoices = voices.filter(voice => voice.lang.includes(targetCode));

            voiceSelect.innerHTML = '';

            if (filteredVoices.length === 0) {
                const opt = document.createElement('option');
                opt.text = "Suara tidak tersedia";
                voiceSelect.appendChild(opt);
            } else {
                filteredVoices.forEach(voice => {
                    const opt = document.createElement('option');
                    opt.textContent = `${voice.name}`;
                    opt.value = voice.name;
                    if (currentLang === 'id' && (voice.name.includes('Indonesia') || voice.name.includes('Google'))) {
                        opt.selected = true;
                    }
                    voiceSelect.appendChild(opt);
                });
            }
        }

        if (synth.onvoiceschanged !== undefined) synth.onvoiceschanged = loadVoices;

        // --- SMART TEXT SPLITTER (THE FIX) ---
        function prepareText(text) {
            // 1. Bersihkan text
            let cleanText = text.replace(/\s+/g, ' ').trim();

            // 2. Split awal berdasarkan tanda baca kalimat
            // Regex ini menangkap ., ?, !, :, ; sebagai pemisah
            let rawChunks = cleanText.match(/[^.?!:;\n]+[.?!:;\n]+|[^.?!:;\n]+$/g) || [cleanText];

            // 3. Refine Chunks: Jika ada chunk > 160 karakter, pecah lagi pakai Koma atau Spasi
            let finalChunks = [];
            const MAX_LENGTH = 160;

            rawChunks.forEach(chunk => {
                if (chunk.length > MAX_LENGTH) {
                    // Coba pecah pakai koma dulu
                    let subChunks = chunk.match(/[^,]+,|[^,]+$/g) || [chunk];

                    subChunks.forEach(sub => {
                        if (sub.length > MAX_LENGTH) {
                            // Kalau masih kepanjangan, potong paksa per spasi terdekat batas
                            const words = sub.split(' ');
                            let temp = '';
                            words.forEach(word => {
                                if ((temp + word).length < MAX_LENGTH) {
                                    temp += word + ' ';
                                } else {
                                    finalChunks.push(temp.trim());
                                    temp = word + ' ';
                                }
                            });
                            if (temp) finalChunks.push(temp.trim());
                        } else {
                            finalChunks.push(sub.trim());
                        }
                    });
                } else {
                    finalChunks.push(chunk.trim());
                }
            });

            return finalChunks.filter(c => c.length > 0);
        }

        // --- PLAYBACK LOGIC ---

        function speakChunk() {
            if (currentSentenceIndex >= sentenceQueue.length) {
                if (isLooping) {
                    currentSentenceIndex = 0;
                    speakChunk();
                } else {
                    stopAll("Selesai");
                }
                return;
            }

            const textChunk = sentenceQueue[currentSentenceIndex];

            // Buat Utterance baru
            window.utterance = new SpeechSynthesisUtterance(textChunk);

            // Apply Settings
            const selectedVoice = voices.find(v => v.name === voiceSelect.value);
            if (selectedVoice) window.utterance.voice = selectedVoice;
            window.utterance.rate = parseFloat(speedInput.value);

            // Event Handlers
            window.utterance.onstart = () => {
                statusMsg.textContent = `Bagian ${currentSentenceIndex + 1} / ${sentenceQueue.length}`;
            };

            window.utterance.onend = () => {
                currentSentenceIndex++;
                speakChunk(); // Rekursif ke chunk berikutnya
            };

            window.utterance.onerror = (e) => {
                console.log("Error chunk, skipping...", e);
                // Force lanjut jika error
                if (e.error !== 'canceled') {
                    currentSentenceIndex++;
                    speakChunk();
                }
            };

            synth.speak(window.utterance);

            // --- KEEP ALIVE TRICK (Anti-Sleep Browser) ---
            clearInterval(keepAliveInterval);
            keepAliveInterval = setInterval(() => {
                if (synth.speaking) {
                    synth.pause();
                    synth.resume();
                } else {
                    clearInterval(keepAliveInterval);
                }
            }, 4000); // Colek browser setiap 4 detik
        }

        function startReading() {
            // Reset dulu
            synth.cancel();
            clearInterval(keepAliveInterval);

            const text = textInput.value;
            if (!text) return alert("Teks kosong!");

            // Proses Text jadi Antrian
            sentenceQueue = prepareText(text);

            if (sentenceQueue.length === 0) return;

            currentSentenceIndex = 0;
            isPlaying = true;

            // UI Update
            textInput.classList.add('highlight-active');
            playBtn.classList.remove('bg-indigo-600', 'hover:bg-indigo-700');
            playBtn.classList.add('bg-red-600', 'hover:bg-red-700');
            document.getElementById('playText').textContent = "Hentikan";

            speakChunk();
        }

        function stopAll(msg = "Berhenti") {
            synth.cancel();
            clearInterval(keepAliveInterval);
            isPlaying = false;
            statusMsg.textContent = msg;
            textInput.classList.remove('highlight-active');

            // Reset Button
            playBtn.classList.add('bg-indigo-600', 'hover:bg-indigo-700');
            playBtn.classList.remove('bg-red-600', 'hover:bg-red-700');
            document.getElementById('playText').textContent = "Mulai Baca";
        }

        // --- BUTTON EVENTS ---

        playBtn.addEventListener('click', () => {
            if (isPlaying) {
                stopAll("Dihentikan User");
            } else {
                startReading();
            }
        });

        loopBtn.addEventListener('click', () => {
            isLooping = !isLooping;
            loopBtn.classList.toggle('text-indigo-500', isLooping);
            loopBtn.classList.toggle('border-indigo-500', isLooping);
            loopBtn.classList.toggle('bg-indigo-50', isLooping);
            loopBtn.classList.toggle('dark:bg-indigo-900/30', isLooping);
        });

        clearBtn.addEventListener('click', () => {
            stopAll("Reset");
            textInput.value = '';
            charCount.textContent = '0 Karakter';
        });

        // Lang Select
        langBtns.forEach(btn => {
            btn.addEventListener('click', () => {
                langBtns.forEach(b => {
                    b.classList.remove('active-lang', 'bg-indigo-100', 'dark:bg-indigo-900/30', 'text-indigo-600', 'dark:text-indigo-400', 'border-indigo-500');
                    b.classList.add('border-zinc-200', 'dark:border-zinc-700');
                });
                btn.classList.add('active-lang', 'bg-indigo-100', 'dark:bg-indigo-900/30', 'text-indigo-600', 'dark:text-indigo-400', 'border-indigo-500');
                btn.classList.remove('border-zinc-200', 'dark:border-zinc-700');
                currentLang = btn.dataset.lang;
                loadVoices();
            });
        });

        // Others
        speedInput.addEventListener('input', (e) => speedValue.textContent = e.target.value + 'x');
        textInput.addEventListener('input', () => charCount.textContent = `${textInput.value.length} Karakter`);

        // Init
        initTheme();
        setTimeout(loadVoices, 500);

        // Styling active
        const activeBtn = document.querySelector('.active-lang');
        if (activeBtn) {
            activeBtn.classList.add('bg-indigo-100', 'dark:bg-indigo-900/30', 'text-indigo-600', 'dark:text-indigo-400', 'border-indigo-500');
            activeBtn.classList.remove('border-zinc-200');
        }
    </script>
</body>

</html>